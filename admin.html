<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salon Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #d63384;
            --primary-hover: #a61e61;
            --dark: #2c3e50;
            --bg: #f4f6f9;
            --white: #ffffff;
            --border: #e0e0e0;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --gray-light: #f8f9fa;
            --gray-text: #888;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg); color: #333; height: 100vh; overflow: hidden; }

        .hidden { display: none !important; }

        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; transition: 0.2s; font-size: 14px; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-sm { padding: 4px 8px; font-size: 12px; }

        /* Login Page */
        #login-section {
            display: flex; justify-content: center; align-items: center; height: 100vh;
            background: linear-gradient(135deg, var(--primary), var(--dark));
        }
        .login-box {
            background: white; padding: 40px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            width: 100%; max-width: 400px; text-align: center;
        }
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; }
        .form-control { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 4px; }

        /* Admin Layout */
        #admin-panel { display: flex; height: 100vh; }
        
        .sidebar { width: 250px; background: var(--dark); color: white; display: flex; flex-direction: column; }
        .brand { padding: 20px; font-size: 20px; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .brand i { color: var(--primary); margin-right: 10px; }
        .nav-links { list-style: none; padding: 20px 0; flex-grow: 1; overflow-y: auto; }
        .nav-links li a { display: block; padding: 12px 20px; color: rgba(255,255,255,0.7); text-decoration: none; transition: 0.3s; display: flex; align-items: center; justify-content: space-between; }
        .nav-links li a i.icon { width: 25px; text-align: center; margin-right: 10px; }
        .nav-links li a:hover, .nav-links li a.active { background: rgba(255,255,255,0.1); color: white; border-left: 4px solid var(--primary); }
        .user-info { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 14px; }

        .main-content { flex-grow: 1; overflow-y: auto; padding: 30px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; }
        .stat-info h3 { font-size: 28px; margin-bottom: 5px; }
        .stat-icon { font-size: 30px; opacity: 0.2; }

        .table-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow-x: auto; }
        .toolbar { display: flex; justify-content: space-between; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); font-size: 14px; }
        th { background: #f8f9fa; color: #555; white-space: nowrap; }
        
        /* Badges */
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .status-unread { background: var(--primary); color: white; }
        .status-read { background: #e9ecef; color: var(--gray-text); border: 1px solid #dee2e6; }
        .status-Pending { background: #fff3cd; color: #856404; }
        .status-Confirmed { background: #d1ecf1; color: #0c5460; }
        .status-Completed { background: #d4edda; color: #155724; }
        .status-Cancelled { background: #f8d7da; color: #721c24; }

        /* Text styles based on read status */
        .unread-row { background-color: #fff0f6; font-weight: 600; }
        .unread-row:hover { background-color: #ffe0eb; }
        .read-row { color: #555; font-weight: 400; }
        .read-row:hover { background-color: #f9f9f9; }

        /* --- SERVICE CARD STYLES (FIXED) --- */
        .service-list-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .service-card { 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); 
            border: 1px solid var(--border);
            transition: 0.3s;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .service-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        /* Green border if Active, Red if Inactive */
        .service-card.disabled { opacity: 0.7; background-color: #fafafa; border-left: 5px solid var(--danger); }
        .service-card.active { border-left: 5px solid var(--success); }

        /* Category Badge Style - MOVED TO LEFT */
        .cat-badge {
            position: absolute;
            top: 15px;
            left: 15px; /* Changed from right: 15px to left: 15px */
            right: auto; /* Prevent stretching */
            background: var(--dark);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 10px;
            text-transform: uppercase;
            font-weight: bold;
            z-index: 2;
            max-width: 120px; /* Prevent super long badges from breaking layout */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sc-content { padding: 20px; display: flex; flex-direction: column; flex-grow: 1; justify-content: space-between;}

        .sc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .sc-title { 
            font-size: 18px; 
            font-weight: 700; 
            color: var(--dark); 
            margin: 0; 
            padding-left: 100px; /* Push title to the right to avoid the badge */
            padding-right: 0; /* Removed old right padding */
        }
        .sc-price { font-size: 18px; font-weight: bold; color: var(--primary); white-space: nowrap; }

        .sc-footer { 
            display: flex; justify-content: space-between; align-items: center; 
            padding-top: 15px; border-top: 1px solid #eee; 
        }

        .sc-actions button { 
            margin-left: 5px; cursor: pointer; border: none; background: none; 
            font-size: 16px; color: #999; transition: 0.2s; 
        }
        .sc-actions button:hover { color: var(--primary); }
        .sc-actions button.btn-delete:hover { color: var(--danger); }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(14px); }
        
        /* --------------------------------------- */
        
        /* Modals */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 450px; position: relative; }
        .close-modal { cursor: pointer; font-size: 20px; float: right; color: #aaa; }
        .close-modal:hover { color: #333; }
        
        /* Message Specific */
        .msg-meta-grid { display: grid; grid-template-columns: 100px 1fr; gap: 15px; margin-bottom: 20px; }
        .msg-label { font-weight: bold; color: #555; font-size: 13px; }
        .msg-body-box { 
            background: #f9f9f9; padding: 20px; border-radius: 6px; 
            border-left: 4px solid var(--primary);
            font-size: 15px; line-height: 1.6; color: #333;
            white-space: pre-wrap; 
        }

        /* ==========================================
           PROFESSIONAL ALERTS & NOTIFICATIONS
        ========================================== */

        /* 1. Custom Confirm Modal */
        #confirm-overlay {
            position: fixed; inset: 0; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999;
            opacity: 0; visibility: hidden;
            transition: all 0.3s ease;
        }

        #confirm-overlay.active {
            opacity: 1; visibility: visible;
        }

        .confirm-box {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            transform: scale(0.8);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }

        #confirm-overlay.active .confirm-box {
            transform: scale(1);
        }

        .confirm-icon {
            width: 60px; height: 60px;
            background: #fff3cd;
            color: #856404;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 20px;
            font-size: 28px;
            font-weight: bold;
        }

        .confirm-box h3 { margin-bottom: 10px; color: var(--dark); }
        .confirm-box p { color: #666; margin-bottom: 25px; line-height: 1.5; }

        .confirm-actions { display: flex; justify-content: center; gap: 15px; }
        .confirm-actions .btn { padding: 10px 25px; border-radius: 25px; }


        /* 2. Professional Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background: #333;
            color: #fff;
            text-align: center;
            border-radius: 50px;
            padding: 12px 24px;
            position: fixed;
            z-index: 3000;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%) translateY(50px);
            opacity: 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        #toast i { color: var(--success); font-size: 16px; }
        
        #toast.show {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        /* Slide out animation is handled by removing the class */

        @media (max-width: 768px) {
            #admin-panel { flex-direction: column; }
            .sidebar { width: 100%; height: auto; }
            .nav-links { display: flex; overflow-x: auto; padding: 10px; }
            .nav-links li a { flex-shrink: 0; }
        }
    </style>
</head>
<body>

    <!-- LOGIN SECTION -->
    <section id="login-section">
        <div class="login-box">
            <h2><i class="fas fa-spa"></i> Salon Admin</h2>
            <p style="margin-bottom: 20px; color: #666;">Login to manage your business</p>
            <form id="login-form">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="email" class="form-control" placeholder="admin@salon.com" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" class="form-control" placeholder="admin123" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;">Login</button>
            </form>
        </div>
    </section>

    <!-- ADMIN PANEL -->
    <section id="admin-panel" class="hidden">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="brand"><i class="fas fa-spa"></i> Blossom Beauty</div>
            <ul class="nav-links">
                <li><a href="#" onclick="navigate('dashboard')" id="nav-dashboard" class="active"><i class="fas fa-home icon"></i> Dashboard</a></li>
                <li><a href="#" onclick="navigate('bookings')" id="nav-bookings"><i class="fas fa-calendar-check icon"></i> Bookings</a></li>
                <li><a href="#" onclick="navigate('services')" id="nav-services"><i class="fas fa-cut icon"></i> Services</a></li>
                <li><a href="#" onclick="navigate('customers')" id="nav-customers"><i class="fas fa-users icon"></i> Customers</a></li>
                <li><a href="#" onclick="navigate('contacts')" id="nav-contacts"><i class="fas fa-envelope icon"></i> Inbox <span id="inbox-badge" style="background:var(--danger); font-size:10px; padding:2px 6px; border-radius:10px; display:none;">0</span></a></li>
            </ul>
            <div class="user-info">
                <p>Admin</p>
                <a href="#" onclick="logout()" style="color: #aaa; text-decoration: none;">Logout</a>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            
            <!-- Dashboard View -->
            <div id="view-dashboard">
                <div class="header"><h2>Dashboard</h2></div>
                <div class="stats-grid">
                    <div class="stat-card" style="border-left: 4px solid var(--info);">
                        <div class="stat-info"><h3 id="dash-today">0</h3><p>Today's Bookings</p></div>
                        <i class="fas fa-calendar-day stat-icon" style="color: var(--info);"></i>
                    </div>
                    <div class="stat-card" style="border-left: 4px solid var(--primary);">
                        <div class="stat-info"><h3 id="dash-msgs">0</h3><p>New Messages</p></div>
                        <i class="fas fa-envelope-open-text stat-icon" style="color: var(--primary);"></i>
                    </div>
                    <div class="stat-card" style="border-left: 4px solid var(--success);">
                        <div class="stat-info"><h3 id="dash-earnings">₹0</h3><p>Total Earnings</p></div>
                        <i class="fas fa-wallet stat-icon" style="color: var(--success);"></i>
                    </div>
                    <div class="stat-card" style="border-left: 4px solid var(--warning);">
                        <div class="stat-info"><h3 id="dash-customers">0</h3><p>Customers</p></div>
                        <i class="fas fa-users stat-icon" style="color: var(--warning);"></i>
                    </div>
                </div>
            </div>

            <!-- Bookings View -->
            <div id="view-bookings" class="hidden">
                <div class="header"><h2>Bookings</h2></div>
                <div class="table-container">
                    <div class="toolbar">
                        <input type="text" id="booking-search" class="form-control" placeholder="Search ID or name..." style="width: 250px;" onkeyup="renderBookings()">
                        <select id="status-filter" class="form-control" style="width: 150px;" onchange="renderBookings()">
                            <option value="All">All Status</option>
                            <option value="Pending">Pending</option>
                            <option value="Confirmed">Confirmed</option>
                            <option value="Completed">Completed</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                    </div>
                    <table id="bookingTable">
                        <thead>
                            <tr>
                                <th>Booking ID</th>
                                <th>Name</th>
                                <th>Service</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="bookings-table">
                            <tr><td colspan="7" style="text-align:center;">Loading bookings...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Services View (SIMPLIFIED) -->
            <div id="view-services" class="hidden">
                <div class="header">
                    <h2>Manage Services</h2>
                    <button class="btn btn-primary" onclick="openServiceModal()"><i class="fas fa-plus"></i> Add Service</button>
                </div>
                
                <!-- Service Grid -->
                <div id="services-list" class="service-list-grid">
                    <p style="text-align:center; grid-column: 1/-1; padding:20px; color:#666;">Loading services...</p>
                </div>
            </div>

            <!-- Customers View -->
            <div id="view-customers" class="hidden">
                <div class="header"><h2>Customers</h2></div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Name</th><th>Phone</th><th>Visits</th></tr></thead>
                        <tbody id="customers-table"></tbody>
                    </table>
                </div>
            </div>

            <!-- INBOX / MESSAGES VIEW -->
            <div id="view-contacts" class="hidden">
                <div class="header">
                    <h2>Message Inbox</h2>
                    <div>
                        <button class="btn btn-sm btn-secondary" onclick="forceRefreshContacts()"><i class="fas fa-sync"></i> Refresh</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteAllContacts()">Clear All</button>
                    </div>
                </div>
                <div class="table-container">
                    <div class="toolbar">
                        <input type="text" id="contact-search" class="form-control" placeholder="Search by name, email, or subject..." style="width: 300px;" onkeyup="renderContacts()">
                        <div style="font-size:12px; color:#666; align-self:center;">
                            Compatible with Status & Read fields
                        </div>
                    </div>
                    <table id="contactTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>From</th>
                                <th>Subject</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="contacts-table">
                            <tr><td colspan="5" style="text-align:center;">Loading messages...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </section>

    <!-- Modal for Services (SIMPLIFIED) -->
    <div id="service-modal" class="modal hidden">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3 id="modal-title">Add Service</h3>
                <span class="close-modal" onclick="closeServiceModal()">&times;</span>
            </div>
            <form id="service-form">
                <input type="hidden" id="service-id">
                <input type="hidden" id="service-status"> 
                
                <div class="form-group">
                    <label>Category</label>
                    <select id="service-category" class="form-control">
                        <option value="Hair Services">Hair Services</option>
                        <option value="Facial Treatments">Facial Treatments</option>
                        <option value="Nail Care">Nail Care</option>
                        <option value="Bridal">Bridal</option>
                        <option value="Spa & Massage">Spa & Massage</option>
                        <option value="Waxing">Waxing</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Service Name</label>
                    <input type="text" id="service-name" class="form-control" placeholder="e.g. Haircut" required>
                </div>
                
                <div class="form-group">
                    <label>Price (₹)</label>
                    <input type="number" id="service-price" class="form-control" placeholder="0" required>
                </div>
                
                <div style="text-align:right; margin-top:20px;">
                    <button type="button" class="btn" onclick="closeServiceModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Service</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MESSAGE DETAILS MODAL -->
    <div id="msg-modal" class="modal hidden">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
                <h3>Message Details</h3>
                <span class="close-modal" onclick="closeMsgModal()">&times;</span>
            </div>
            
            <div id="msg-details-body">
                <!-- Injected via JS -->
            </div>

            <div style="margin-top:25px; display:flex; gap:10px; justify-content:flex-end;">
                <button class="btn btn-secondary" id="btn-mark-unread" onclick="toggleMsgStatus(currentMsgId)">
                    <i class="fas fa-envelope"></i> Mark as Unread
                </button>
                <button class="btn btn-primary" onclick="closeMsgModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- CUSTOM CONFIRM MODAL (PROFESSIONAL ALERT) -->
    <div id="confirm-overlay">
        <div class="confirm-box">
            <div class="confirm-icon">!</div>
            <h3 id="confirm-title">Are You Sure?</h3>
            <p id="confirm-msg">This action cannot be undone.</p>
            <div class="confirm-actions">
                <button class="btn btn-secondary" id="confirm-no">Cancel</button>
                <button class="btn btn-danger" id="confirm-yes">Yes, Delete</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast"><i class="fas fa-check-circle"></i> <span id="toast-msg">Notification</span></div>

    <script>
        // --- CONFIGURATION ---
        const API_URL = "http://localhost:3000";
        // FIX: Updated to Option B to match backend routing (/api/contacts/contact)
        const CONTACT_ENDPOINT = `${API_URL}/api/contacts/contact`;
        const BOOKING_ENDPOINT = `${API_URL}/api/bookings`;
        const SERVICE_ENDPOINT = `${API_URL}/api/services`;

        // State Management
        let allBookings = [];
        let allContacts = [];
        let contactsInterval = null; 
        let currentMsgId = null; 

        // --- AUTH ---
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            if(email === 'admin@salon.com' && pass === 'admin123') {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                loadDashboard(); 
            } else {
                showToast("Wrong credentials");
            }
        });

        function logout() { location.reload(); }

        // --- NAVIGATION ---
        function navigate(page) {
            document.querySelectorAll('.main-content > div').forEach(d => d.classList.add('hidden'));
            document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
            document.getElementById('view-' + page).classList.remove('hidden');
            document.getElementById('nav-' + page).classList.add('active');

            if(contactsInterval) {
                clearInterval(contactsInterval);
                contactsInterval = null;
            }

            if(page === 'dashboard') loadDashboard();
            if(page === 'bookings') { fetchBookings().then(() => renderBookings()); }
            if(page === 'services') fetchServices();
            if(page === 'customers') { fetchBookings().then(() => renderCustomers()); }
            if(page === 'contacts') { 
                fetchContacts(); 
                contactsInterval = setInterval(() => {
                    fetchContacts(true); 
                }, 30000);
            }
        }

        // =========================
        // DASHBOARD
        // =========================
        async function loadDashboard() {
            await Promise.all([fetchBookings(), fetchContacts()]);
            
            const today = new Date().toISOString().split('T')[0];
            const todayCount = allBookings.filter(b => b.date === today).length;
            const unreadCount = allContacts.filter(c => getIsUnread(c)).length;
            const earnings = allBookings.filter(b => b.status === 'Completed').reduce((sum, b) => sum + (b.price || 0), 0);
            const customers = new Set(allBookings.map(b => b.phone)).size;

            document.getElementById('dash-today').innerText = todayCount;
            document.getElementById('dash-msgs').innerText = unreadCount;
            document.getElementById('dash-earnings').innerText = "₹" + earnings;
            document.getElementById('dash-customers').innerText = customers;

            updateInboxBadge(unreadCount);
        }

        function updateInboxBadge(count) {
            const badge = document.getElementById('inbox-badge');
            if(count > 0) {
                badge.style.display = 'inline-block';
                badge.innerText = count;
            } else {
                badge.style.display = 'none';
            }
        }

        // =========================
        // BOOKINGS
        // =========================
        async function fetchBookings() {
            try {
                const response = await fetch(BOOKING_ENDPOINT);
                if(!response.ok) throw new Error("API Error");
                allBookings = await response.json();
            } catch (error) { 
                console.log("Booking API Error:", error); 
                allBookings = []; 
            } 
        }

        // STEP 3: Cancel Button
        async function cancelBooking(id) {
            try {
                const res = await fetch(`${BOOKING_ENDPOINT}/cancel/${id}`, {
                    method: "PUT"
                });
                const data = await res.json();
                showToast(data.message || "Booking Cancelled");
                fetchBookings().then(renderBookings);
            } catch (err) {
                console.error(err);
                showToast("Failed to cancel booking");
            }
        }

        // STEP 3: Confirm Button
        async function confirmBooking(id) {
            try {
                const res = await fetch(`${BOOKING_ENDPOINT}/confirm/${id}`, {
                    method: "PUT"
                });
                const data = await res.json();
                showToast(data.message || "Booking Confirmed");
                fetchBookings().then(renderBookings);
            } catch (err) {
                console.error(err);
                showToast("Failed to confirm booking");
            }
        }

        function renderBookings() {
            const tbody = document.getElementById('bookings-table');
            const search = document.getElementById('booking-search').value.toLowerCase();
            const filter = document.getElementById('status-filter').value;
            tbody.innerHTML = '';
            
            const filtered = allBookings.filter(b => {
                const match = b.name.toLowerCase().includes(search) || (b._id && b._id.includes(search));
                return match && (filter === 'All' || b.status === filter);
            });

            if(filtered.length === 0) return tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No bookings found.</td></tr>';

            filtered.forEach(b => {
                const displayId = b.bookingId || (b._id ? b._id.substring(0, 8) : 'N/A');
                
                // Build Action HTML
                let actionHtml = `
                            <select class="form-control" style="padding:4px; width:auto;" onchange="updateStatus('${b._id}', this.value)">
                                <option value="Pending" ${b.status==='Pending'?'selected':''}>Pending</option>
                                <option value="Confirmed" ${b.status==='Confirmed'?'selected':''}>Confirm</option>
                                <option value="Completed" ${b.status==='Completed'?'selected':''}>Complete</option>
                                <option value="Cancelled" ${b.status==='Cancelled'?'selected':''}>Cancel</option>
                            </select>`;

                // Add Confirm Button only if Status is Pending
                if(b.status === 'Pending') {
                    actionHtml = `
                        <button class="btn btn-sm btn-success" onclick="confirmBooking('${b._id}')" title="Confirm & Send Email" style="margin-right: 8px;">
                            <i class="fas fa-check"></i> Confirm
                        </button>
                    ` + actionHtml;
                }

                // Add Cancel Button only if Status is Confirmed
                if(b.status === 'Confirmed') {
                    actionHtml = `
                        <button class="btn btn-sm btn-danger" onclick="cancelBooking('${b._id}')" title="Cancel Booking" style="margin-right: 8px;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    ` + actionHtml;
                }

                tbody.innerHTML += `
                    <tr>
                        <td><code>${displayId}</code></td>
                        <td><strong>${b.name}</strong><br><small>${b.phone}</small></td>
                        <td>${b.serviceName || "—"}<br><small>₹${b.price || 0}</small></td>
                        <td>${b.date}</td>
                        <td>${b.time}</td>
                        <td><span class="status-badge status-${b.status}">${b.status}</span></td>
                        <td style="display:flex; align-items:center;">${actionHtml}</td>
                    </tr>`;
            });
        }

        async function updateStatus(id, status) {
            try {
                await fetch(`${BOOKING_ENDPOINT}/${id}`, { 
                    method: 'PUT', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ status }) 
                });
                showToast("Booking Updated");
                fetchBookings().then(renderBookings);
            } catch (e) { showToast("Error updating"); }
        }

        function renderCustomers() {
            const tbody = document.getElementById('customers-table');
            tbody.innerHTML = '';
            const map = {};
            allBookings.forEach(b => { 
                if(!map[b.phone]) map[b.phone] = { name: b.name, visits: 0 }; 
                map[b.phone].visits++; 
            });
            
            if(Object.keys(map).length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">No customers yet.</td></tr>';
                return;
            }

            Object.keys(map).forEach(phone => tbody.innerHTML += `<tr><td>${map[phone].name}</td><td>${phone}</td><td>${map[phone].visits}</td></tr>`);
        }

        // =========================
        // SERVICES (SIMPLIFIED)
        // =========================
        async function fetchServices() {
            try {
                const res = await fetch(SERVICE_ENDPOINT);
                if(!res.ok) throw new Error("API Error");
                renderServices(await res.json());
            } catch (err) { 
                document.getElementById('services-list').innerHTML = "<p style='color:red; text-align:center;'>Error loading services.</p>"; 
            }
        }

        function renderServices(services) {
            const list = document.getElementById('services-list');
            list.innerHTML = '';
            if(!services || services.length === 0) {
                list.innerHTML = "<p style='text-align:center;'>No services found.</p>";
                return;
            }
            services.forEach(s => {
                const isActive = (s.status === 'active' || s.status === true || s.status === 'true');
                const statusClass = isActive ? 'active' : 'disabled';

                list.innerHTML += `
                    <div class="service-card ${statusClass}">
                        <span class="cat-badge">${s.category || 'General'}</span>
                        
                        <div class="sc-content">
                            <div class="sc-header">
                                <h3 class="sc-title">${s.name}</h3>
                                <div class="sc-price">₹${s.price}</div>
                            </div>

                            <div class="sc-footer">
                                <div style="display:flex; align-items:center;">
                                    <label class="switch">
                                        <input type="checkbox" ${isActive ? 'checked' : ''} onchange="toggleServiceStatus('${s._id}', this.checked)">
                                        <span class="slider"></span>
                                    </label>
                                    <span class="status-text" style="font-size:11px; margin-left:6px; color:${isActive ? 'var(--success)' : '#999'}">
                                        ${isActive ? 'Available' : 'Unavailable'}
                                    </span>
                                </div>
                                
                                <div class="sc-actions">
                                    <button title="Edit" onclick="editService('${s._id}')"><i class="fas fa-edit"></i></button>
                                    <button title="Delete" class="btn-delete" onclick="deleteService('${s._id}')"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>`;
            });
        }

        async function toggleServiceStatus(id, isChecked) {
            const newStatus = isChecked ? 'active' : 'inactive';
            try {
                await fetch(`${SERVICE_ENDPOINT}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                showToast(`Service ${newStatus === 'active' ? 'Available' : 'Unavailable'}`);
                fetchServices(); 
            } catch (err) { 
                showToast("Error updating status");
                fetchServices(); 
            }
        }

        // FORM SUBMIT
        document.getElementById('service-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('service-id').value;
            const name = document.getElementById('service-name').value;
            const price = document.getElementById('service-price').value;
            const category = document.getElementById('service-category').value;
            
            let status = document.getElementById('service-status').value;
            if(!id) status = 'active';

            // Simple JSON payload (No FormData needed)
            const payload = { name, price, category, status };

            const method = id ? 'PUT' : 'POST';
            const url = id ? `${SERVICE_ENDPOINT}/${id}` : SERVICE_ENDPOINT;
            
            try {
                const res = await fetch(url, { 
                    method: method, 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if(!res.ok) throw new Error("Save failed");
                showToast("Service Saved!");
                closeServiceModal(); 
                fetchServices();
            } catch (err) { 
                console.error(err);
                showToast("Error saving service"); 
            }
        });

        async function editService(id) {
            try {
                const res = await fetch(`${SERVICE_ENDPOINT}/${id}`);
                const s = await res.json();
                
                document.getElementById('modal-title').innerText = "Edit Service";
                document.getElementById('service-id').value = s._id;
                document.getElementById('service-name').value = s.name;
                document.getElementById('service-price').value = s.price;
                document.getElementById('service-category').value = s.category || 'Hair Services';
                document.getElementById('service-status').value = s.status || 'active';
                
                document.getElementById('service-modal').classList.remove('hidden');
            } catch(e) { showToast("Error fetching service details"); }
        }

        async function deleteService(id) {
            // Replaced native confirm with custom professional modal
            showConfirm("Delete Service", "Are you sure you want to delete this service? This cannot be undone.", async () => {
                try {
                    await fetch(`${SERVICE_ENDPOINT}/${id}`, { method: 'DELETE' }); 
                    fetchServices(); 
                    showToast("Service Deleted"); 
                } catch(e) { showToast("Error deleting service"); }
            });
        }

        function openServiceModal() {
            document.getElementById('service-form').reset();
            document.getElementById('service-id').value = '';
            document.getElementById('modal-title').innerText = "Add Service";
            document.getElementById('service-status').value = ''; 
            document.getElementById('service-modal').classList.remove('hidden');
        }
        
        function closeServiceModal() { document.getElementById('service-modal').classList.add('hidden'); }


        // =========================
        // CONTACTS / INBOX LOGIC (FIXED)
        // =========================

        // FIX 1: Simplified getIsUnread (Single Source of Truth)
        function getIsUnread(contact) {
            return contact.read !== true;
        }

        // FIX 2: Remove status from setLocalStatus
        function setLocalStatus(contact, isRead) {
            contact.read = isRead;
        }

        async function fetchContacts(isSilent = false) {
            try {
                const res = await fetch(CONTACT_ENDPOINT);
                if (!res.ok) throw new Error("API Error");
                const data = await res.json();
                allContacts = Array.isArray(data) ? data : [];
            } catch (error) {
                console.error("Contact API Error:", error);
                if (!isSilent) showToast("Error fetching messages");
                allContacts = []; 
            }
            renderContacts();
            const unreadCount = allContacts.filter(c => getIsUnread(c)).length;
            updateInboxBadge(unreadCount);
        }

        async function forceRefreshContacts() {
            showToast("Refreshing inbox...");
            await fetchContacts(true);
            showToast("Inbox Updated");
        }

        function renderContacts() {
            const tbody = document.getElementById('contacts-table');
            const search = document.getElementById('contact-search').value.toLowerCase();
            tbody.innerHTML = '';

            const filtered = allContacts.filter(c =>
                (c.name && c.name.toLowerCase().includes(search)) ||
                (c.subject && c.subject.toLowerCase().includes(search)) ||
                (c.email && c.email.toLowerCase().includes(search))
            );

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No messages found.</td></tr>';
                return;
            }

            filtered.forEach(c => {
                const isUnread = getIsUnread(c);
                // FIX: Corrected operator precedence for dateStr
                const dateStr = new Date(c.date || c.createdAt).toLocaleDateString();
                const rowClass = isUnread ? 'unread-row' : 'read-row';
                const badgeClass = isUnread ? 'status-unread' : 'status-read';
                const badgeText = isUnread ? 'NEW' : 'READ';

                tbody.innerHTML += `
                    <tr class="${rowClass}">
                        <td>${dateStr}</td>
                        <td>
                            <div>${c.name}</div>
                            <small style="font-weight:400; color:${isUnread ? '#666' : '#999'};">${c.email}</small>
                        </td>
                        <td>${c.subject}</td>
                        <td><span class="status-badge ${badgeClass}">${badgeText}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewMessage('${c._id}')" title="View Message"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-secondary" onclick="toggleMsgStatus('${c._id}')" title="Toggle Read"><i class="fas ${isUnread ? 'fa-envelope-open' : 'fa-envelope'}"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteContact('${c._id}')" title="Delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        async function viewMessage(id) {
            const msg = allContacts.find(c => c._id === id);
            if (!msg) return;
            currentMsgId = id;

            if (getIsUnread(msg)) {
                setLocalStatus(msg, true);
                renderContacts();
                updateInboxBadge(allContacts.filter(c => getIsUnread(c)).length);
                
                try {
                    // FIX 3: Stop sending status to backend
                    await fetch(`${CONTACT_ENDPOINT}/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ read: true })
                    });
                } catch (e) { console.error("Backend update failed", e); }
            }

            const detailsBody = document.getElementById('msg-details-body');
            // FIX: Corrected operator precedence for dateStr
            const dateStr = new Date(msg.date || msg.createdAt).toLocaleString();

            detailsBody.innerHTML = `
                <div class="msg-meta-grid">
                    <div class="msg-label">Name:</div>
                    <div>${msg.name}</div>
                    <div class="msg-label">Email:</div>
                    <div><a href="mailto:${msg.email}">${msg.email}</a></div>
                    <div class="msg-label">Date:</div>
                    <div>${dateStr}</div>
                    <div class="msg-label">Subject:</div>
                    <div><strong>${msg.subject}</strong></div>
                </div>
                <div class="msg-label" style="margin-bottom:5px;">Message:</div>
                <div class="msg-body-box">${msg.message}</div>
            `;

            updateMsgModalButton(msg);
            document.getElementById('msg-modal').classList.remove('hidden');
        }

        function updateMsgModalButton(msg) {
            const toggleBtn = document.getElementById('btn-mark-unread');
            if (getIsUnread(msg)) {
                toggleBtn.innerHTML = '<i class="fas fa-envelope-open"></i> Mark as Read';
                toggleBtn.className = 'btn btn-primary';
            } else {
                toggleBtn.innerHTML = '<i class="fas fa-envelope"></i> Mark as Unread';
                toggleBtn.className = 'btn btn-secondary';
            }
        }

        function closeMsgModal() {
            document.getElementById('msg-modal').classList.add('hidden');
            currentMsgId = null;
        }

        async function toggleMsgStatus(id, isSilent = false) {
            const msg = allContacts.find(c => c._id === id);
            if (!msg) return;

            const isCurrentlyRead = !getIsUnread(msg);
            const newStatusRead = !isCurrentlyRead;

            setLocalStatus(msg, newStatusRead);
            renderContacts();
            if(currentMsgId === id) updateMsgModalButton(msg);
            updateInboxBadge(allContacts.filter(c => getIsUnread(c)).length);

            try {
                // FIX 3: Stop sending status to backend
                const payload = newStatusRead 
                    ? { read: true } 
                    : { read: false };

                const res = await fetch(`${CONTACT_ENDPOINT}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error("Update failed");

                if (!isSilent) {
                    showToast(newStatusRead ? 'Marked as Read' : 'Marked as Unread');
                }
            } catch (error) {
                console.error("Failed to update message status:", error);
                setLocalStatus(msg, isCurrentlyRead);
                renderContacts();
                if(currentMsgId === id) updateMsgModalButton(msg);
                if(!isSilent) showToast("Error updating status");
            }
        }

        async function deleteContact(id) {
            // Replaced native confirm with custom professional modal
            showConfirm("Delete Message", "Are you sure you want to delete this message?", async () => {
                try {
                    const res = await fetch(`${CONTACT_ENDPOINT}/${id}`, { method: 'DELETE' });
                    if (!res.ok) throw new Error();
                    allContacts = allContacts.filter(c => c._id !== id);
                    renderContacts();
                    updateInboxBadge(allContacts.filter(c => getIsUnread(c)).length);
                    showToast("Message Deleted");
                } catch (error) {
                    console.error("Failed to delete message:", error);
                    showToast("Error deleting message");
                }
            });
        }

        async function deleteAllContacts() {
            // Replaced native confirm with custom professional modal
            showConfirm("Delete All Messages", "Delete ALL messages? This cannot be undone.", async () => {
                try {
                    const res = await fetch(CONTACT_ENDPOINT, { method: 'DELETE' });
                    if (!res.ok) throw new Error();
                    allContacts = [];
                    renderContacts();
                    updateInboxBadge(0);
                    showToast("All messages cleared");
                } catch (error) {
                    console.error("Failed to delete all messages:", error);
                    showToast("Error clearing messages");
                }
            });
        }

        // =========================
        // PROFESSIONAL UI HELPERS
        // =========================

        function showToast(msg) {
            const x = document.getElementById("toast");
            const msgSpan = document.getElementById("toast-msg");
            msgSpan.innerText = msg; 
            x.className = "show";
            setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000);
        }

        function showConfirm(title, message, callback) {
            const overlay = document.getElementById('confirm-overlay');
            const titleEl = document.getElementById('confirm-title');
            const msgEl = document.getElementById('confirm-msg');
            const yesBtn = document.getElementById('confirm-yes');
            const noBtn = document.getElementById('confirm-no');

            titleEl.innerText = title;
            msgEl.innerText = message;

            // Remove old listeners to prevent stacking
            const newYes = yesBtn.cloneNode(true);
            yesBtn.parentNode.replaceChild(newYes, yesBtn);

            const newNo = noBtn.cloneNode(true);
            noBtn.parentNode.replaceChild(newNo, noBtn);

            overlay.classList.add('active');

            newYes.addEventListener('click', () => {
                overlay.classList.remove('active');
                callback();
            });

            newNo.addEventListener('click', () => {
                overlay.classList.remove('active');
            });
        }

    </script>
</body>
</html>